<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMU 헬스장</title>
<link rel="icon" href="images/logo_image.png">
<link rel="stylesheet" type="text/css" href="style-size.css"/>
<link rel="stylesheet" type="text/css" href="style-layout.css"/>
<link rel="stylesheet" type="text/css" href="style-presentation.css"/>
<script type="text/javascript" src="loginStatus.js"></script>
<script type="text/javascript">
    const CouponsNum = ['COUPON123', 'DISCOUNT20', 'PROMO2023', 'X-mas']; // 쿠폰번호 예시

     // 기간 선택 시 금액 계산 함수
    function calculateTotalAmount() {
        var dropdown = document.getElementsByName('dropdown')[0];
        var selectedOption = dropdown.options[dropdown.selectedIndex].text; // 예: "1개월"
        var numberOfMonths = parseInt(selectedOption.match(/\d+/)[0]); // "1개월"에서 숫자 1 추출
        var amountPerMonth = 10000; // 1개월 당 금액

        // 할인 계산: 3개월마다 1000원 할인
        var discount = Math.floor(numberOfMonths / 3) * 1000;

        var totalAmount = (numberOfMonths * amountPerMonth) - discount; // 총 금액 계산 (할인 적용)

        // 쿠폰 할인 확인
        var couponText = document.getElementById('coupon-text').value;
        if (CouponsNum.includes(couponText.toUpperCase())) {
            totalAmount *= 0.8; // 20% 할인
        }

        document.getElementById('total').value = totalAmount; // 총 금액을 텍스트 필드에 표시
    }

    function paymentProcess(){
        var dropdown = document.getElementsByName('dropdown')[0];
        var selectedOption = dropdown.options[dropdown.selectedIndex].text; // 예: "1개월"
        var total = document.getElementById('total').value;
        var paymentMethods = document.getElementsByName('payment');
        var paymentMethodSelected = false;

        for (var i = 0; i < paymentMethods.length; i++) {
            if (paymentMethods[i].checked) {
                paymentMethodSelected = true;
                break;
            }
        }

        if (dropdown && paymentMethodSelected) {
            // 기존 만료 날짜 가져오기
            var currentUserId = sessionStorage.getItem('currentUser');
            var existingExpiryDateString = localStorage.getItem(currentUserId + '_expiryDate');
            var expiryDate;

            if (existingExpiryDateString) {
                // 기존 만료 날짜가 존재하는 경우, 해당 날짜를 사용
                expiryDate = new Date(existingExpiryDateString);
            } else {
                // 기존 만료 날짜가 없는 경우, 현재 날짜를 기준으로 설정
                expiryDate = new Date();
            }

            // 새로운 결제 기간 추가
            var numberOfMonths = parseInt(selectedOption.match(/\d+/)[0]);
            expiryDate.setMonth(expiryDate.getMonth() + numberOfMonths);

            // 업데이트된 만료 날짜를 로컬 스토리지에 저장
            localStorage.setItem(currentUserId + '_expiryDate', expiryDate.toISOString());

            updateRemainingDays();
            alert('결제되었습니다.');

        } else if(!dropdown){
            alert('기간을 입력해주세요.');
        } else if(!paymentMethodSelected){
            alert('결제방법을 입력해주세요.');
        } else {
            alert('필드를 입력해주세요.');
        }
    }
    // 페이지 로드 시 남은 일수 업데이트 함수
    function updateRemainingDays() {
        var currentUserId = sessionStorage.getItem('currentUser');
        var expiryDateString = localStorage.getItem(currentUserId + '_expiryDate');

        if (expiryDateString) {
            var expiryDate = new Date(expiryDateString);
            var today = new Date();
            var remainingDays = Math.round((expiryDate - today) / (1000 * 60 * 60 * 24));

            // 남은 일수 업데이트
            document.getElementById('membership-date').querySelector('p:last-child').textContent = remainingDays + " 일";

            // 등록 현황 업데이트
            if (remainingDays == 0){
                document.getElementById('membership').querySelector('p:last-child').textContent = "미등록";
            }else {
                document.getElementById('membership').querySelector('p:last-child').textContent = "등록";
            }
            
        }
    }
    // 모달 (사물함 비밀번호 설정창) 화면에 표시
    function showLockerModal() {
        document.getElementById('lockerModal').style.display = 'block';
    }
    // 사물함 비밀번호 로컬스토리지에 저장
    function saveLockerPassword() {
        var lockerPassword = document.getElementById('lockerPasswordInput').value;

        if(lockerPassword && lockerPassword.length === 4) {
            var currentUserId = sessionStorage.getItem('currentUser');
            localStorage.setItem(currentUserId + '_lockerPassword', lockerPassword);

            document.getElementById('lockerModal').style.display = 'none'; // 모달 숨기기
            updateLockerStatus(); // 사물함 상태 업데이트
        } else {
            alert('4자리 숫자를 입력해주세요.');
        }
    }
    // 사물함 등록상태 업데이트
    function updateLockerStatus(){
        //var lockerContainer = document.querySelector('.locker');
        var lockerDate = document.querySelector('#locker-date');
        var locker_Password = document.querySelector('#locker-password-num');
        var currentUserId = sessionStorage.getItem('currentUser');
        var lockerPassword = localStorage.getItem(currentUserId + '_lockerPassword');

        if (lockerPassword) {
            // 사물함 비밀번호가 있으면 사물함 정보 표시
            lockerDate.innerHTML =  new Date().toLocaleDateString();
            locker_Password.innerHTML = lockerPassword;
        } else {
            // 사물함 비밀번호가 없으면 등록 메시지와 버튼 표시
            //lockerContainer.innerHTML = '<p>사물함을 등록하세요</p><button onclick="showLockerModal();">등록하기</button>';
            lockerDate.textContent = '사물함을 등록하세요';
            locker_Password.innerHTML = '<button onclick="showLockerModal();">등록하기</button>';
        }
    }
    //윈도우 화면이 로드되었을 때 실행되는 이벤트 리스너
    window.addEventListener('load', function()  { 
        // 세션 스토리지에서 'currentUser' 항목의 값을 가져옵니다.
        var currentUserId = sessionStorage.getItem('currentUser');
        
        // 'text-profile' ID를 가진 요소를 찾고, 존재한다면 해당 요소의 내용을 업데이트합니다.
        var profileText = document.getElementById('text-profile');
        if (profileText && currentUserId) {
            profileText.textContent = currentUserId + ' 님,  안녕하세요.';
        }
    
        // 페이지 로드 시 남은 일수 업데이트
        updateRemainingDays();

        // 드롭다운 변경 시 이벤트 리스너 추가
        var dropdown = document.getElementsByName('dropdown')[0];
        dropdown.addEventListener('change', calculateTotalAmount);
        // 쿠폰 입력 시 이벤트 리스너 추가
        var couponInput = document.getElementById('coupon-text');
        couponInput.addEventListener('input', calculateTotalAmount);

        // 사물함 등록상태 업데이트
        updateLockerStatus();
        
     } );
    
</script>
</head>

<body>
<div class="menu_bar">
    <a href="main.html"><img src="images/sum_logo_menu.png" alt="SMU LOGO"/></a>
    <ul>
        <li class="dropdown"><a href="#">헬스장 소개</a>
            <div class="dropdown-content">
                <a href="introduce_location.html">위치 및 정보</a>
                <a href="introduce_calender.html">운영시간</a>
                <a href="introduce_trainers.html">트레이너 소개</a>
            </div>
        </li>
        <li><a href="notice.html">공지사항</a></li>
        <li><a href="health.html">운동 기구 소개</a></li>
        <li><a href="service_center.html">고객센터</a></li>
    </ul>
    <span>
        <a href="login.html" id="loginLink">로그인</a>
        /
        <a href="mypage.html">마이페이지</a>
    </span>
</div>

<div class="html_screen">
    <h2 id="mypage-title">MyPage</h2>

    <div class="profile">
        <img src="images/sumung_profile.png">
        <p id="text-profile">로그인이 필요합니다</p>
        <div id="membership">
            <p class="sub-membership">등록현황</p><p>미등록</p>
        </div>
        <div id="membership-date">
            <p class="sub-membership">남은 일수</p><p>0 일</p>
        </div>
    </div>

    <div class="subtitle">
        사물함
    </div>

    <div class="inline">
        <p>등록 날짜</p>
        <p id="locker-password">사물함 비밀번호</p>
    </div>

    <div class="locker">
        <p id="locker-date"></p><p id="locker-password-num"></p>
    </div>

    <div class="subtitle">
        등록 및 결제
    </div>
    <form id="regi-pay">    
        <fieldset>
            <span class="field">기간</span>
            <select name="dropdown">
                <option value="option1">1개월</option><option value="option2">2개월</option>
                <option value="option3">3개월</option><option value="option4">4개월</option>
                <option value="option5">5개월</option><option value="option6">6개월</option>
                <option value="option7">7개월</option><option value="option8">8개월</option>
                <option value="option9">9개월</option><option value="option10">10개월</option>
                <option value="option11">11개월</option><option value="option12">12개월</option>
            </select><br>

            <span class="field">쿠폰</span>
            <input id="coupon-text" type="text"/><br/>

            <span class="field">결제금액</span>
            <input id="total" type="text"/>원<br/>
            
            <span class="field">결제방법</span>
            <input type="radio" id="option1" name="payment" value="cash">
            <label for="option1">현금</label>
            <input type="radio" id="option2" name="payment" value="card">
            <label for="option2">카드</label>
            <input type="radio" id="option3" name="payment" value="coupon">
            <label for="option3">쿠폰</label><br>

            <div class="button">
                <input id="payment_btn" type="button" value="결제하기" onclick="paymentProcess();"/>
            </div>
        </fieldset>
    </form> 
</div>
<!-- 사물함 등록 모달 -->
<div id="lockerModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>사물함 등록</h3>
        <input id="lockerPasswordInput" type="text" maxlength="4" placeholder="4자리 비밀번호" pattern="\d{4}" required>
        <button onclick="saveLockerPassword();">등록</button>
    </div>
</div>

</body>
</html>